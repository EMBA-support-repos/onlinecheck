name: Update EMBA version details

on:
  schedule:
    - cron: '0 0 * * *' # do it every day
  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:


jobs:
  update_version:
    if: github.repository_owner == 'EMBA-support-repos'
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Branch
      uses: actions/checkout@v3
    - name: Install requirements
      run: |
        sudo apt-get update -y
        sudo apt-get install curl -y
        # sudo apt-get install docker.io -y
    - name: update EMBA version details
      run: |
        curl --connect-timeout 5 -s -o - https://github.com/e-m-b-a/emba/blob/master/config/VERSION.txt | grep -w "rawLines" | sed -E 's/.*"rawLines":\[\"([0-9]\.[0-9]\.[0-9])(.*)\"\]\,.*/\1\2/' > EMBA_VERSION.txt
        curl --connect-timeout 5 -s -o - https://github.com/e-m-b-a/emba | grep "spoofed_commit_check" | sed -E 's/.*commit_check\/([a-zA-Z0-9]{8}).*/\1/' > EMBA_GITHUB_HASH.txt
        curl --connect-timeout 5 -s -o - https://github.com/e-m-b-a/embark | grep "spoofed_commit_check" | sed -E 's/.*commit_check\/([a-zA-Z0-9]{8}).*/\1/' > EMBArk_GITHUB_HASH.txt
        sudo docker manifest inspect embeddedanalyzer/emba:latest -v | jq . | grep "digest" | head -n1 | awk '{print $2}' | sed -E 's/"sha256:(.+)",/\1/' > EMBA_CONTAINER_HASH.txt
        curl --connect-timeout 5 -s -o - https://github.com/EMBA-support-repos/nvd-json-data-feeds | grep "spoofed_commit_check" | sed -E 's/.*commit_check\/([a-zA-Z0-9]{8}).*/\1/' > NVD_HASH.txt
    - name: Create Pull Request
      id: cpr
      uses: peter-evans/create-pull-request@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        commit-message: Update EMBA version details
        committer: GitHub <noreply@github.com>
        author: ${{ github.actor }} <${{ github.actor }}@users.noreply.github.com>
        signoff: false
        branch: update_emba_version_details
        delete-branch: true
        title: 'Update EMBA version details'
        body: |
          Update report
          - Nightly update of EMBA version details
        labels: |
          automerge
          automated pr
        milestone: 0
        draft: false
